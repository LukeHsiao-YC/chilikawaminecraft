<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Âêâ‰ºäÂç°ÂìáÔºöÊ≥®Èü≥ÂÆ∂ÂúíÂ§ßÂÜíÈö™</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'M PLUS Rounded 1c', "Noto Sans TC", sans-serif;
            background-color: #fdf6e3;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #a5d6a7;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        /* UI Layers */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            box-sizing: border-box;
            z-index: 10;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .hud-left, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #8d6e63;
            border-radius: 12px;
            padding: 8px 15px;
            font-size: 18px;
            font-weight: 800;
            color: #5d4037;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .exp-container {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            width: 150px;
            height: 10px;
            overflow: hidden;
            position: relative;
            margin-top: 5px;
        }
        .exp-bar {
            background: #4fc3f7;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .mode-badge {
            font-size: 20px;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .mode-home { background: #66bb6a; border: 2px solid #2e7d32; }
        .mode-work { background: #81c784; border: 2px solid #388e3c; }
        .mode-raid { background: #ef5350; border: 2px solid #c62828; }

        /* Action Buttons */
        .action-btn {
            background: #fff;
            border: 3px solid #ffa000;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 20px;
            font-weight: bold;
            color: #5d4037;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-go-weed { background: #c8e6c9; border-color: #388e3c; color: #1b5e20; }
        .btn-go-raid { background: #ffcdd2; border-color: #d32f2f; color: #b71c1c; }
        .btn-go-home { background: #fff9c4; border-color: #fbc02d; color: #f57f17; }

        /* Build Menu (Only visible in Home Mode) */
        #build-palette {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            border: 3px solid #8d6e63;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .build-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
            position: relative;
        }
        .build-item:hover { background: #fff8e1; }
        .build-item.selected { background: #ffe0b2; border-color: #ff6f00; }
        
        .build-item.locked {
            opacity: 0.6;
            background: #eee;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        .lock-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: #d32f2f;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }
        
        /* Screens */
        .modal-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            border: 6px solid #ff8a80;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        h1, h2 { margin: 0 0 15px 0; color: #ff8a80; text-shadow: 2px 2px 0 #fff; }
        
        .btn-primary {
            background: #ff8a80;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 800;
            box-shadow: 0 5px 0 #d84315;
            min-width: 140px;
        }
        .btn-primary:active { transform: translateY(5px); box-shadow: none; }
        .btn-continue { background: #66bb6a; box-shadow: 0 5px 0 #388e3c; }

        .difficulty-group { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .diff-btn {
            background: #fff; border: 3px solid #ddd; border-radius: 12px; padding: 10px 15px;
            font-size: 16px; font-weight: bold; color: #888; cursor: pointer; transition: 0.2s;
        }
        .diff-btn.selected {
            background: #e1f5fe; border-color: #29b6f6; color: #0277bd;
            transform: scale(1.05); box-shadow: 0 4px 10px rgba(41, 182, 246, 0.2);
        }

        .char-select { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .char-card {
            border: 3px solid #eee; border-radius: 15px; padding: 10px; width: 100px;
            cursor: pointer; transition: 0.2s;
        }
        .char-card.selected { border-color: #ff8a80; background: #fff5f5; transform: translateY(-5px); }
        
        .notification {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 20px 40px;
            border-radius: 50px; font-size: 24px; pointer-events: none;
            opacity: 0; transition: opacity 0.5s;
            z-index: 200;
        }

    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            <div class="hud-top">
                <!-- Left Side: Stats -->
                <div class="hud-left">
                    <div class="info-box">
                        <div>
                            <div>üëë Lv.<span id="level-display">1</span></div>
                            <div class="exp-container">
                                <div id="exp-bar" class="exp-bar"></div>
                            </div>
                        </div>
                    </div>
                    <div class="info-box">üí∞ <span id="score">0</span> ÂÜÜ</div>
                    
                    <div id="timer-display" class="info-box timer-box" style="display:none;">‚è∞ <span id="timer">60</span>s</div>
                    <div id="home-indicator" class="mode-badge mode-home">üè† Ê∫´È¶®ÂÆ∂Âúí</div>
                    <div id="work-indicator" class="mode-badge mode-work" style="display:none;">üå± Èô§ËçâÊ™¢ÂÆö‰∏≠</div>
                    <div id="raid-indicator" class="mode-badge mode-raid" style="display:none;">‚öîÔ∏è Ë®é‰ºê‰ªªÂãô‰∏≠</div>
                </div>

                <!-- Right Side: Controls -->
                <div class="hud-right">
                    <!-- Home Mode Controls -->
                    <div id="home-controls">
                        <button class="action-btn btn-go-weed" onclick="switchToWorkMode('weed')">
                            üå± Èô§ËçâÊ™¢ÂÆö
                            <span style="font-size:12px; margin-left:5px; color:#555">(ÁßªÂãïÈô§Ëçâ)</span>
                        </button>
                        <button class="action-btn btn-go-raid" onclick="switchToWorkMode('raid')">
                            ‚öîÔ∏è Ë®é‰ºê‰ªªÂãô
                            <span style="font-size:12px; margin-left:5px; color:#555">(Èò≤ÂÆàÊîªÊìä)</span>
                        </button>
                        
                        <div style="margin-top: 10px;">
                            <button class="action-btn" onclick="toggleBuildMenu()" style="width:100%; justify-content:center;">üî® ‰ΩàÁΩÆÂÆ∂Âúí</button>
                            <div id="build-palette">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                    </div>

                    <!-- Work/Raid Mode Controls -->
                    <div id="work-controls" style="display:none;">
                         <button class="action-btn btn-go-home" onclick="returnHome()">
                            üèÉ ÈÄÉÂõûÂÆ∂
                        </button>
                        <div id="weed-hint" class="info-box keyboard-hint" style="margin-top:10px; display:none;">
                             WASD ÁßªÂãï / Èù†ËøëËº∏ÂÖ•Ê≥®Èü≥
                        </div>
                        <div id="raid-hint" class="info-box keyboard-hint" style="margin-top:10px; display:none;">
                             ÊÄ™Áâ©Èù†Ëøë‰∏≠ÔºÅËº∏ÂÖ•Ê≥®Èü≥ÊîªÊìä
                        </div>
                    </div>
                </div>
            </div>

            <!-- Start Screen -->
            <div id="start-screen" class="modal-screen">
                <div class="modal-content">
                    <h1>Âêâ‰ºäÂç°Âìá<br>Ê≥®Èü≥ÂÆ∂Âúí</h1>
                    <p>Èô§ËçâË≥∫Èå¢ÔºåË®é‰ºêÂçáÁ¥öÔºÅ<br>Âä™ÂäõÊääÂÆ∂Ë£°Ë£ùÈ£æÂæóÊºÇÊºÇ‰∫Æ‰∫ÆÂêßÔºÅ</p>
                    
                    <div class="difficulty-group">
                        <div class="diff-btn" onclick="setDifficulty('easy')" id="diff-easy">üê¢ ÊÖ¢ÈÄü</div>
                        <div class="diff-btn selected" onclick="setDifficulty('normal')" id="diff-normal">üêπ Ê≠£Â∏∏</div>
                        <div class="diff-btn" onclick="setDifficulty('hard')" id="diff-hard">üî• Âø´ÈÄü</div>
                    </div>

                    <div class="char-select">
                        <div class="char-card selected" onclick="selectChar('chiikawa')" id="c-chiikawa">
                            <div style="font-size:30px;">üêπ</div>Âêâ‰ºäÂç°Âìá
                        </div>
                        <div class="char-card" onclick="selectChar('hachiware')" id="c-hachiware">
                            <div style="font-size:30px;">üê±</div>Â∞èÂÖ´
                        </div>
                        <div class="char-card" onclick="selectChar('usagi')" id="c-usagi">
                            <div style="font-size:30px;">üê∞</div>ÁÉèËñ©Â•á
                        </div>
                    </div>
                    
                    <!-- Buttons Container -->
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                        <button id="btn-continue" class="btn-primary btn-continue" style="display:none;" onclick="initGame(true)">ËÆÄÂèñÈÄ≤Â∫¶</button>
                        <button class="btn-primary" onclick="initGame(false)">ÈáçÊñ∞ÈñãÂßã</button>
                    </div>
                </div>
            </div>

            <!-- Work Result Screen -->
            <div id="result-screen" class="modal-screen" style="display: none;">
                <div class="modal-content">
                    <h2 id="result-title">Â∑•‰ΩúÁµêÊùü</h2>
                    <p>Êú¨Ê¨°Êî∂ÂÖ•: +<span id="result-income">0</span> ÂÜÜ</p>
                    <p>Áç≤ÂæóÁ∂ìÈ©ó: +<span id="result-exp">0</span> EXP</p>
                    <button class="btn-primary" onclick="switchToHomeMode()">ÂõûÂà∞ÂÆ∂Âúí</button>
                </div>
            </div>
            
            <div id="notification" class="notification">ÈÄöÁü•</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Config ---
        const HOME_WIDTH = 2000;
        const HOME_HEIGHT = 2000;
        const WEED_MAP_WIDTH = 1500;
        const WEED_MAP_HEIGHT = 1500;
        
        let VIEW_WIDTH = window.innerWidth;
        let VIEW_HEIGHT = window.innerHeight;

        const ZHUYIN_MAP = {
            '1': '„ÑÖ', 'q': '„ÑÜ', 'a': '„Ñá', 'z': '„Ñà',
            '2': '„Ñâ', 'w': '„Ñä', 's': '„Ñã', 'x': '„Ñå',
            'e': '„Ñç', 'd': '„Ñé', 'c': '„Ñè',
            'r': '„Ñê', 'f': '„Ñë', 'v': '„Ñí',
            '5': '„Ñì', 't': '„Ñî', 'g': '„Ñï', 'b': '„Ññ',
            'y': '„Ñó', 'h': '„Ñò', 'n': '„Ñô',
            'u': '„Ñß', 'j': '„Ñ®', 'm': '„Ñ©',
            '8': '„Ñö', 'i': '„Ñõ', 'k': '„Ñú', ',': '„Ñù',
            '9': '„Ñû', 'o': '„Ñü', 'l': '„Ñ†', '.': '„Ñ°',
            '0': '„Ñ¢', 'p': '„Ñ£', ';': '„Ñ§', '/': '„Ñ•',
            '-': '„Ñ¶', '3': 'Àá', '4': 'Àã', '6': 'Àä', '7': 'Àô'
        };
        const ZHUYIN_KEYS = Object.keys(ZHUYIN_MAP);

        const BUILD_ITEMS = [
            { name: 'ËòëËèáÂ±ã', cost: 100, icon: 'üçÑ', type: 0, w: 80, h: 80, unlockLv: 1, action: "ÈÄôÊòØÊàëÂÆ∂ÔºÅ" },
            { name: 'ËçâËìÜ', cost: 50, icon: 'üõèÔ∏è', type: 1, w: 50, h: 30, unlockLv: 1, action: "Zzz..." },
            { name: 'Ëä±ÂúÉ', cost: 30, icon: 'üå∑', type: 2, w: 40, h: 40, unlockLv: 2, action: "È¶ôÈ¶ôÁöÑÔΩû" },
            { name: 'ÂúçÁâÜ', cost: 20, icon: 'üß±', type: 3, w: 40, h: 40, unlockLv: 2, action: "......" },
            { name: 'ÈÉéÊãâÈ∫µ', cost: 300, icon: 'üçú', type: 4, w: 100, h: 80, unlockLv: 3, action: "ÈÉéÔºÅ" },
            { name: 'Ê∫´Ê≥â', cost: 500, icon: '‚ô®Ô∏è', type: 5, w: 120, h: 100, unlockLv: 5, action: "ÂëºÔΩûÂ•ΩËàíÊúç" },
            { name: 'Âêâ‰ºäÂÉè', cost: 1000, icon: 'üóø', type: 6, w: 60, h: 100, unlockLv: 8, action: "Âìá..." }
        ];

        const CHAR_STATS = {
            chiikawa: { color: '#ffffff', luck: 1.2 },
            hachiware: { color: '#ffffff', luck: 1.0 },
            usagi: { color: '#fdd835', luck: 0.8 }
        };

        const DIFFICULTY = {
            easy: { spawnRate: 120, speed: 0.8 },
            normal: { spawnRate: 80, speed: 1.5 },
            hard: { spawnRate: 40, speed: 2.5 }
        };

        // --- Game State ---
        let currentMode = 'MENU'; // MENU, HOME, WORK
        let workModeType = 'weed'; // 'weed' or 'raid'
        let selectedChar = 'chiikawa';
        let selectedDiff = 'normal';
        
        // Progression
        let score = 500;
        let playerLevel = 1;
        let playerExp = 0;
        let expToNextLevel = 100;
        
        // Home State
        let homePlayer = { x: 1000, y: 1000, facing: 1, speech: null, speechTimer: 0 };
        let buildings = []; // {x, y, typeId}
        let camera = { x: 0, y: 0 };
        let isBuildMenuOpen = false;
        let selectedBuildIdx = 0;
        let nearbyBuildingIdx = -1; // Index of building player is close to

        // Work State
        let weedPlayer = { x: WEED_MAP_WIDTH/2, y: WEED_MAP_HEIGHT/2, facing: 1 };
        let workTimer = 0;
        let workEntities = []; 
        let workSessionScore = 0;
        let workSessionExp = 0;
        let workSpawnTimer = 0;
        let playerInvulnerable = 0;

        // Input
        const keys = { w: false, a: false, s: false, d: false };
        let mouse = { x: 0, y: 0 };

        // --- Loop ---
        function loop() {
            update();
            render();
            requestAnimationFrame(loop);
        }

        function update() {
            if (currentMode === 'HOME') updateHome();
            else if (currentMode === 'WORK') updateWork();
        }

        function render() {
            ctx.clearRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
            if (currentMode === 'HOME') renderHome();
            else if (currentMode === 'WORK') renderWork();
        }

        // --- HOME LOGIC ---
        function updateHome() {
            let speed = 6;
            let dx = 0, dy = 0;
            if (keys.w) dy = -speed;
            if (keys.s) dy = speed;
            if (keys.a) dx = -speed;
            if (keys.d) dx = speed;

            // Proposed new position
            let nextX = homePlayer.x + dx;
            let nextY = homePlayer.y + dy;
            let playerRadius = 20;
            let collision = false;

            // Collision Detection with Buildings
            for (let b of buildings) {
                let item = BUILD_ITEMS[b.type];
                let centerX = b.x;
                let centerY = b.y + 10;
                let radiusX = item.w / 2;
                let radiusY = 15; 

                if (Math.abs(nextX - centerX) < (radiusX + playerRadius - 5) && 
                    Math.abs(nextY - centerY) < (radiusY + playerRadius - 5)) {
                    collision = true;
                    break;
                }
            }

            if (!collision) {
                homePlayer.x = Math.max(50, Math.min(HOME_WIDTH-50, nextX));
                homePlayer.y = Math.max(50, Math.min(HOME_HEIGHT-50, nextY));
            }
            
            if (dx !== 0) homePlayer.facing = Math.sign(dx);

            // Interaction Check
            nearbyBuildingIdx = -1;
            let closestDist = 9999;
            for (let i = 0; i < buildings.length; i++) {
                let b = buildings[i];
                let item = BUILD_ITEMS[b.type];
                let dist = Math.hypot(homePlayer.x - b.x, homePlayer.y - (b.y + 10));
                // Interaction range roughly related to object size
                if (dist < (item.w/2 + 50) && dist < closestDist) {
                    closestDist = dist;
                    nearbyBuildingIdx = i;
                }
            }

            // Speech Timer
            if (homePlayer.speechTimer > 0) homePlayer.speechTimer--;
            else homePlayer.speech = null;

            camera.x = homePlayer.x - VIEW_WIDTH/2;
            camera.y = homePlayer.y - VIEW_HEIGHT/2;
            camera.x = Math.max(0, Math.min(HOME_WIDTH-VIEW_WIDTH, camera.x));
            camera.y = Math.max(0, Math.min(HOME_HEIGHT-VIEW_HEIGHT, camera.y));
        }

        function renderHome() {
            ctx.save();
            ctx.translate(-camera.x, -camera.y);

            ctx.fillStyle = '#a5d6a7';
            ctx.fillRect(camera.x, camera.y, VIEW_WIDTH, VIEW_HEIGHT);
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            for(let x=0; x<HOME_WIDTH; x+=100) ctx.fillRect(x, 0, 2, HOME_HEIGHT);
            for(let y=0; y<HOME_HEIGHT; y+=100) ctx.fillRect(0, y, HOME_WIDTH, 2);

            buildings.sort((a,b) => a.y - b.y);
            
            let renderList = [];
            renderList.push({y: homePlayer.y, type:'player'});
            buildings.forEach(b => renderList.push({y: b.y + 20, type:'building', obj: b}));
            
            renderList.sort((a,b) => a.y - b.y);
            
            renderList.forEach(item => {
                if (item.type === 'player') drawPlayer(homePlayer.x, homePlayer.y, homePlayer.facing);
                else drawBuilding(item.obj);
            });

            // Draw Speech Bubble
            if (homePlayer.speech) {
                drawSpeechBubble(homePlayer.x, homePlayer.y - 50, homePlayer.speech);
            }

            // Draw Interaction Hint
            if (nearbyBuildingIdx !== -1) {
                let b = buildings[nearbyBuildingIdx];
                drawInteractionHint(b.x, b.y - 60);
            }

            if (isBuildMenuOpen) {
                let worldMx = mouse.x + camera.x;
                let worldMy = mouse.y + camera.y;
                drawBuildGhost(worldMx, worldMy);
            }

            ctx.restore();
        }

        function drawSpeechBubble(x, y, text) {
            ctx.font = "bold 16px sans-serif";
            let width = ctx.measureText(text).width + 20;
            let height = 30;
            
            ctx.fillStyle = "white";
            ctx.strokeStyle = "black";
            ctx.lineWidth = 2;
            
            // Bubble
            ctx.beginPath();
            ctx.roundRect(x - width/2, y - height, width, height, 10);
            ctx.fill();
            ctx.stroke();
            
            // Pointer
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - 5, y - 5); // Connect to bubble bottom
            ctx.lineTo(x + 5, y - 5);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, x, y - height/2);
        }

        function drawInteractionHint(x, y) {
            let bob = Math.sin(Date.now() * 0.01) * 5;
            let text = "ÊåâÁ©∫ÁôΩÈçµ";
            
            ctx.font = "bold 14px sans-serif";
            let width = ctx.measureText(text).width + 16;
            
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.beginPath();
            ctx.roundRect(x - width/2, y - 30 + bob, width, 24, 12);
            ctx.fill();
            
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, x, y - 18 + bob);
        }

        // --- WORK LOGIC ---
        function updateWork() {
            workTimer -= 1/60;
            if (workTimer <= 0) {
                finishWork(true);
                return;
            }

            if (workModeType === 'weed') {
                // WEED MODE: Player moves, Weeds are static
                let speed = 6;
                let dx = 0, dy = 0;
                if (keys.w) dy = -speed;
                if (keys.s) dy = speed;
                if (keys.a) dx = -speed;
                if (keys.d) dx = speed;

                weedPlayer.x += dx;
                weedPlayer.y += dy;
                weedPlayer.x = Math.max(50, Math.min(WEED_MAP_WIDTH-50, weedPlayer.x));
                weedPlayer.y = Math.max(50, Math.min(WEED_MAP_HEIGHT-50, weedPlayer.y));
                if (dx !== 0) weedPlayer.facing = Math.sign(dx);

                // Camera for Weed Mode
                camera.x = weedPlayer.x - VIEW_WIDTH/2;
                camera.y = weedPlayer.y - VIEW_HEIGHT/2;
                camera.x = Math.max(0, Math.min(WEED_MAP_WIDTH-VIEW_WIDTH, camera.x));
                camera.y = Math.max(0, Math.min(WEED_MAP_HEIGHT-VIEW_HEIGHT, camera.y));

                // Spawn more weeds if low
                if (workEntities.length < 30 && Math.random() < 0.1) {
                     spawnWorkEntity(0);
                }

            } else {
                // RAID MODE: Player fixed, Enemies move
                workSpawnTimer++;
                let settings = DIFFICULTY[selectedDiff];
                let rate = settings.spawnRate * 0.7; 

                if (workSpawnTimer > rate) {
                    spawnWorkEntity(settings.speed);
                    workSpawnTimer = 0;
                }

                let centerX = VIEW_WIDTH / 2;
                let centerY = VIEW_HEIGHT / 2;

                for (let i = workEntities.length - 1; i >= 0; i--) {
                    let e = workEntities[i];
                    let angle = Math.atan2(centerY - e.y, centerX - e.x);
                    e.x += Math.cos(angle) * e.speed;
                    e.y += Math.sin(angle) * e.speed;

                    let dist = Math.hypot(centerX - e.x, centerY - e.y);
                    if (dist < 40) {
                        if (e.type === 'enemy') {
                            playerInvulnerable = 30;
                            let penalty = 50;
                            if (workSessionScore < penalty) workSessionScore = 0;
                            else workSessionScore -= penalty;
                            showNotification("ÁóõÔºÅÊâ£Ëñ™Ê∞¥ÔºÅ");
                        }
                        workEntities.splice(i, 1);
                    }
                }
            }
            
            if (playerInvulnerable > 0) playerInvulnerable--;
            
            document.getElementById('timer').innerText = Math.ceil(workTimer);
            document.getElementById('score').innerText = score + workSessionScore;
        }

        function spawnWorkEntity(baseSpeed) {
            let key = ZHUYIN_KEYS[Math.floor(Math.random() * ZHUYIN_KEYS.length)];
            
            if (workModeType === 'weed') {
                // Random pos in Weed Map
                let ex = Math.random() * (WEED_MAP_WIDTH - 100) + 50;
                let ey = Math.random() * (WEED_MAP_HEIGHT - 100) + 50;
                workEntities.push({
                    x: ex, y: ey,
                    type: 'weed',
                    targetKey: key,
                    zhuyin: ZHUYIN_MAP[key],
                    speed: 0 // Static
                });
            } else {
                // Edge pos for Raid
                let side = Math.floor(Math.random() * 4);
                let ex, ey;
                let margin = 50;
                if (side === 0) { ex = Math.random() * VIEW_WIDTH; ey = -margin; }
                else if (side === 1) { ex = VIEW_WIDTH + margin; ey = Math.random() * VIEW_HEIGHT; }
                else if (side === 2) { ex = Math.random() * VIEW_WIDTH; ey = VIEW_HEIGHT + margin; }
                else { ex = -margin; ey = Math.random() * VIEW_HEIGHT; }
                
                workEntities.push({
                    x: ex, y: ey,
                    type: 'enemy',
                    targetKey: key,
                    zhuyin: ZHUYIN_MAP[key],
                    speed: baseSpeed * 1.5 + (Math.random() * 0.5)
                });
            }
        }

        function renderWork() {
            if (workModeType === 'weed') {
                // WEED RENDER (Map style)
                ctx.save();
                ctx.translate(-camera.x, -camera.y);

                // BG
                ctx.fillStyle = '#c5e1a5';
                ctx.fillRect(camera.x, camera.y, VIEW_WIDTH, VIEW_HEIGHT);
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                for(let x=0; x<WEED_MAP_WIDTH; x+=100) ctx.fillRect(x, 0, 2, WEED_MAP_HEIGHT);
                for(let y=0; y<WEED_MAP_HEIGHT; y+=100) ctx.fillRect(0, y, WEED_MAP_WIDTH, 2);

                // Sort
                let renderList = [];
                renderList.push({y: weedPlayer.y, type:'player'});
                workEntities.forEach(e => renderList.push({y: e.y, type:'weed', obj: e}));
                renderList.sort((a,b)=>a.y-b.y);

                renderList.forEach(item => {
                    if(item.type==='player') drawPlayer(weedPlayer.x, weedPlayer.y, weedPlayer.facing);
                    else drawWeed(item.obj.x, item.obj.y, item.obj.zhuyin);
                });

                ctx.restore();

            } else {
                // RAID RENDER (Tower Defense style)
                ctx.fillStyle = '#3e2723'; 
                ctx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
                
                let cx = VIEW_WIDTH / 2;
                let cy = VIEW_HEIGHT / 2;
                
                ctx.beginPath();
                ctx.arc(cx, cy, 100, 0, Math.PI*2);
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 5;
                ctx.stroke();

                workEntities.forEach(e => {
                    if (e.type === 'enemy') drawEnemy(e.x, e.y, e.zhuyin);
                    else drawWeed(e.x, e.y, e.zhuyin);
                });

                if (playerInvulnerable > 0 && Math.floor(Date.now()/50)%2===0) {
                    // blink
                } else {
                    drawPlayer(cx, cy, 1);
                }
            }
        }

        // --- Character Drawing Logic (Refined) ---
        function drawPlayer(x, y, facing) {
            ctx.save();
            ctx.translate(x, y);
            if (facing < 0) ctx.scale(-1, 1);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(0, 25, 20, 8, 0, 0, Math.PI*2); ctx.fill();

            if (selectedChar === 'chiikawa') drawChiikawa(ctx);
            else if (selectedChar === 'hachiware') drawHachiware(ctx);
            else if (selectedChar === 'usagi') drawUsagi(ctx);

            ctx.restore();
        }

        function drawChiikawa(ctx) {
            // Body (White)
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.ellipse(0, 5, 28, 25, 0, 0, Math.PI*2); // Head/Body
            ctx.fill();
            
            // Ears (Round)
            ctx.beginPath();
            ctx.arc(-20, -15, 9, 0, Math.PI*2); // L
            ctx.arc(20, -15, 9, 0, Math.PI*2); // R
            ctx.fill();
            
            // Outline
            ctx.strokeStyle = '#3e2723'; // Dark brown
            ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.arc(-20, -15, 9, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(20, -15, 9, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.ellipse(0, 5, 28, 25, 0, 0, Math.PI*2); ctx.stroke();

            // Tail
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.arc(-20, 20, 5, 0, Math.PI*2); ctx.fill(); ctx.stroke();

            drawFace(ctx, 'chiikawa');
        }

        function drawHachiware(ctx) {
            const blueColor = '#4da6ff'; 

            // 1. Ears (Behind)
            ctx.fillStyle = blueColor;
            ctx.strokeStyle = '#3e2723';
            ctx.lineWidth = 1.5;

            // Left Ear
            ctx.beginPath();
            ctx.moveTo(-20, -15); ctx.lineTo(-35, -35); ctx.lineTo(-10, -20);
            ctx.fill(); ctx.stroke();

            // Right Ear
            ctx.beginPath();
            ctx.moveTo(20, -15); ctx.lineTo(35, -35); ctx.lineTo(10, -20);
            ctx.fill(); ctx.stroke();

            // 2. Head (White)
            ctx.fillStyle = '#ffffff';
            ctx.beginPath(); ctx.ellipse(0, 5, 29, 26, 0, 0, Math.PI*2); 
            ctx.fill(); ctx.stroke();

            // 3. Blue Hachi Pattern
            ctx.fillStyle = blueColor;
            ctx.beginPath();
            // Lowered bangs: sides from 0 to 2, center peak from -25 to -16
            ctx.moveTo(-29, 2); 
            ctx.quadraticCurveTo(-15, -5, -4, -16); 
            ctx.lineTo(4, -16); 
            ctx.quadraticCurveTo(15, -5, 29, 2); 
            
            ctx.lineTo(29, -35); 
            ctx.lineTo(-29, -35);
            ctx.fill();
            
            // 4. Tail
            ctx.fillStyle = blueColor;
            ctx.beginPath(); ctx.arc(-20, 20, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();

            // 5. Face
            drawFace(ctx, 'hachiware');
        }

        function drawUsagi(ctx) {
            ctx.fillStyle = '#fff176'; // Yellow
            
            // Ears (Long)
            ctx.beginPath(); ctx.ellipse(-15, -35, 8, 20, -0.2, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.ellipse(15, -35, 8, 20, 0.2, 0, Math.PI*2); ctx.fill(); ctx.stroke();

            // Body
            ctx.beginPath(); ctx.ellipse(0, 5, 28, 25, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 1.5; ctx.stroke();
            
            // Tail (White Fluffy)
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.arc(-20, 20, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();

            drawFace(ctx, 'usagi');
        }

        function drawFace(ctx, type) {
            ctx.fillStyle = '#3e2723'; 
            
            if (type === 'chiikawa') {
                // Eyes (Dots)
                ctx.beginPath(); ctx.arc(-10, 0, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(10, 0, 3, 0, Math.PI*2); ctx.fill();
                // Eyebrows
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(-15, -10); ctx.quadraticCurveTo(-10, -12, -5, -10); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(5, -10); ctx.quadraticCurveTo(10, -12, 15, -10); ctx.stroke();
                // Mouth
                ctx.beginPath(); ctx.moveTo(-2, 8); ctx.quadraticCurveTo(0, 10, 2, 8); ctx.stroke();
            } else if (type === 'hachiware') {
                // Eyes (Larger, more expressive)
                ctx.beginPath(); ctx.arc(-10, 0, 4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(10, 0, 4, 0, Math.PI*2); ctx.fill();
                
                // Eyebrows (Slightly tilted up for a determined look)
                ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.moveTo(-14, -8); ctx.lineTo(-6, -6); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(14, -8); ctx.lineTo(6, -6); ctx.stroke();
                
                // Mouth (w) - slightly more defined curve
                ctx.beginPath(); 
                ctx.moveTo(-5, 8); 
                ctx.quadraticCurveTo(-2.5, 10, 0, 8); 
                ctx.quadraticCurveTo(2.5, 10, 5, 8); 
                ctx.stroke();
            } else if (type === 'usagi') {
                // Eyes (Big Dots)
                ctx.beginPath(); ctx.arc(-12, 0, 4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(12, 0, 4, 0, Math.PI*2); ctx.fill();
                // Mouth (Bunny)
                ctx.beginPath(); ctx.moveTo(-3, 8); ctx.lineTo(0, 7); ctx.lineTo(3, 8); ctx.stroke();
            }

            // Blush
            ctx.fillStyle = '#ffcdd2';
            ctx.globalAlpha = 0.6;
            ctx.beginPath(); ctx.arc(-18, 5, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(18, 5, 5, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;
        }

        function drawWeed(x, y, char) {
            ctx.save();
            ctx.translate(x, y);
            let bob = Math.sin(Date.now() * 0.01) * 5;
            ctx.translate(0, bob);
            
            ctx.fillStyle = '#66bb6a';
            ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(-15,-30, -30,-10); ctx.quadraticCurveTo(-10,-10, 0,0); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(15,-30, 30,-10); ctx.quadraticCurveTo(0,-10, 0,0); ctx.fill();
            
            drawZhuyinBubble(0, -30, char, '#8d6e63');
            ctx.restore();
        }

        function drawEnemy(x, y, char) {
            ctx.save();
            ctx.translate(x, y);
            let bob = Math.sin(Date.now() * 0.01) * 5;
            ctx.translate(0, bob);

            ctx.fillStyle = '#5c6bc0';
            ctx.beginPath(); ctx.arc(0, -15, 20, 0, Math.PI*2); ctx.fill();
            // Wings
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.beginPath(); ctx.ellipse(-20, -25, 12, 6, -0.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(20, -25, 12, 6, 0.5, 0, Math.PI*2); ctx.fill();
            
            drawZhuyinBubble(0, -45, char, '#ef5350');
            ctx.restore();
        }

        function drawZhuyinBubble(dx, dy, char, color) {
            if (!char) return;
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.arc(dx, dy, 18, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = 'black'; ctx.font = "bold 20px 'Noto Serif TC'"; 
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(char, dx, dy+2);
        }

        function drawBuilding(b) {
            ctx.save();
            ctx.translate(b.x, b.y);
            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath(); ctx.ellipse(0, 10, b.w/2, 10, 0, 0, Math.PI*2); ctx.fill();
            
            if (b.type === 0) { // Mushroom
                ctx.fillStyle = '#ffe0b2'; ctx.fillRect(-20, -30, 40, 30);
                ctx.fillStyle = '#ef5350'; ctx.beginPath(); ctx.arc(0, -30, 45, Math.PI, 0); ctx.fill();
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-20, -45, 8, 0, Math.PI*2); ctx.fill();
            } else if (b.type === 1) { // Bed
                ctx.fillStyle = '#dcedc8'; ctx.fillRect(-25, -15, 50, 30);
                ctx.fillStyle = 'white'; ctx.fillRect(-20, -10, 15, 20);
            } else if (b.type === 2) { // Flower
                ctx.fillStyle = '#8d6e63'; ctx.beginPath(); ctx.ellipse(0, 0, 20, 10, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#e91e63'; ctx.font = "20px serif"; ctx.fillText("üå∑", -10, 5);
            } else if (b.type === 3) { // Wall
                ctx.fillStyle = '#bdbdbd'; ctx.fillRect(-20, -20, 40, 30);
                ctx.strokeStyle = '#757575'; ctx.strokeRect(-20,-20,40,30);
            } else if (b.type === 4) { // Ramen
                ctx.fillStyle = '#ffecb3'; ctx.fillRect(-40, -40, 80, 40);
                ctx.fillStyle = '#d84315'; ctx.font = "30px serif"; ctx.fillText("ÈÉé", -15, -10);
                ctx.strokeStyle = '#5d4037'; ctx.strokeRect(-40, -40, 80, 40);
            } else if (b.type === 5) { // Onsen
                ctx.fillStyle = '#80deea'; ctx.beginPath(); ctx.ellipse(0, 0, 50, 30, 0, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#5d4037'; ctx.lineWidth = 4; ctx.stroke();
                ctx.font = "24px serif"; ctx.fillStyle = "#e0f7fa"; ctx.fillText("‚ô®Ô∏è", -12, 10);
            } else if (b.type === 6) { // Statue
                ctx.fillStyle = '#9e9e9e'; ctx.fillRect(-20, -60, 40, 60);
                ctx.beginPath(); ctx.arc(0, -60, 25, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(-15, -75, 8, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(15, -75, 8, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }

        function drawBuildGhost(x, y) {
            let item = BUILD_ITEMS[selectedBuildIdx];
            if (!item) return;

            ctx.save();
            ctx.translate(x, y);
            ctx.globalAlpha = 0.6;
            
            let locked = playerLevel < item.unlockLv;
            let canAfford = score >= item.cost;
            
            if (locked) {
                ctx.fillStyle = '#9e9e9e'; 
            } else {
                ctx.fillStyle = canAfford ? '#81c784' : '#e57373';
            }
            
            ctx.beginPath(); ctx.arc(0,0, 40, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black'; ctx.font = "30px sans-serif"; 
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(item.icon, 0, 0);
            
            if(locked) {
                ctx.font = "16px sans-serif";
                ctx.fillStyle = "white";
                ctx.fillText(`Lv.${item.unlockLv}`, 0, -50);
            }

            ctx.restore();
        }

        // --- Save / Load Logic ---
        function saveGameData() {
            const data = {
                score,
                playerLevel,
                playerExp,
                buildings,
                selectedChar,
                selectedDiff,
                expToNextLevel
            };
            localStorage.setItem('chiikawa_save', JSON.stringify(data));
            console.log("Game Saved", data);
            showNotification("ÈÄ≤Â∫¶Â∑≤ÂÑ≤Â≠òÔºÅ");
        }

        function loadGameData() {
            const json = localStorage.getItem('chiikawa_save');
            if (json) {
                const data = JSON.parse(json);
                score = data.score !== undefined ? data.score : 500;
                playerLevel = data.playerLevel !== undefined ? data.playerLevel : 1;
                playerExp = data.playerExp !== undefined ? data.playerExp : 0;
                expToNextLevel = data.expToNextLevel !== undefined ? data.expToNextLevel : 100;
                buildings = data.buildings || [];
                selectedChar = data.selectedChar || 'chiikawa';
                selectedDiff = data.selectedDiff || 'normal';
                
                // UI Updates
                updateExpBar();
                selectChar(selectedChar);
                setDifficulty(selectedDiff);
                return true;
            }
            return false;
        }
        
        function hasSaveData() {
            return localStorage.getItem('chiikawa_save') !== null;
        }

        // --- Game Controls ---
        function initGame(isContinue) {
            if (isContinue) {
                if (!loadGameData()) {
                    showNotification("Êâæ‰∏çÂà∞Â≠òÊ™îÔºåÈñãÂßãÊñ∞ÈÅäÊà≤");
                    // Continue failed, default values are already set
                }
            } else {
                // New Game
                score = 500;
                playerLevel = 1;
                playerExp = 0;
                expToNextLevel = 100;
                buildings = [];
                // Char/Diff keep selection from UI
                saveGameData(); // Overwrite old save
            }
            
            document.getElementById('start-screen').style.display = 'none';
            switchToHomeMode();
            updateExpBar();
        }

        function switchToHomeMode() {
            currentMode = 'HOME';
            document.getElementById('home-controls').style.display = 'block';
            document.getElementById('work-controls').style.display = 'none';
            document.getElementById('home-indicator').style.display = 'block';
            document.getElementById('work-indicator').style.display = 'none';
            document.getElementById('raid-indicator').style.display = 'none';
            document.getElementById('timer-display').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            
            if (workSessionScore > 0 || workSessionExp > 0) {
                score += workSessionScore;
                gainExp(workSessionExp);
                workSessionScore = 0;
                workSessionExp = 0;
                saveGameData(); // Auto save after work
            }
            document.getElementById('score').innerText = score;
        }

        function switchToWorkMode(type) {
            currentMode = 'WORK';
            workModeType = type;
            
            document.getElementById('home-controls').style.display = 'none';
            document.getElementById('work-controls').style.display = 'block';
            document.getElementById('home-indicator').style.display = 'none';
            document.getElementById('timer-display').style.display = 'flex';
            
            if (type === 'weed') {
                document.getElementById('work-indicator').style.display = 'block';
                document.getElementById('raid-indicator').style.display = 'none';
                document.getElementById('weed-hint').style.display = 'flex';
                document.getElementById('raid-hint').style.display = 'none';
                
                // Init Weed Player position
                weedPlayer.x = WEED_MAP_WIDTH/2;
                weedPlayer.y = WEED_MAP_HEIGHT/2;
                
                // Initial Spawns
                workEntities = [];
                for(let i=0; i<30; i++) spawnWorkEntity(0);
                
            } else {
                document.getElementById('work-indicator').style.display = 'none';
                document.getElementById('raid-indicator').style.display = 'block';
                document.getElementById('weed-hint').style.display = 'none';
                document.getElementById('raid-hint').style.display = 'flex';
                
                workEntities = [];
            }
            
            workTimer = 60;
            workSessionScore = 0;
            workSessionExp = 0;
            isBuildMenuOpen = false;
            document.getElementById('build-palette').style.display = 'none';
        }

        function finishWork(finished) {
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('result-title').innerText = finished ? "Â∑•‰ΩúÂÆåÊàêÔºÅ" : "ÊèêÊó©ÂõûÂÆ∂";
            document.getElementById('result-income').innerText = workSessionScore;
            document.getElementById('result-exp').innerText = workSessionExp;
        }
        
        function returnHome() {
            if (currentMode === 'WORK') {
                finishWork(false);
            } else {
                switchToHomeMode();
            }
        }

        function gainExp(amount) {
            playerExp += amount;
            while(playerExp >= expToNextLevel) {
                playerExp -= expToNextLevel;
                playerLevel++;
                expToNextLevel = Math.floor(expToNextLevel * 1.5);
                showNotification(`ÂçáÁ¥ö‰∫ÜÔºÅLv.${playerLevel}`);
            }
            updateExpBar();
        }

        function updateExpBar() {
            document.getElementById('level-display').innerText = playerLevel;
            let percent = (playerExp / expToNextLevel) * 100;
            document.getElementById('exp-bar').style.width = percent + '%';
        }

        function showNotification(msg) {
            let el = document.getElementById('notification');
            el.innerText = msg;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 1500);
        }

        // --- Interactions ---
        function toggleBuildMenu() {
            isBuildMenuOpen = !isBuildMenuOpen;
            const menu = document.getElementById('build-palette');
            
            if (isBuildMenuOpen) {
                menu.innerHTML = ''; // Clear
                BUILD_ITEMS.forEach((item, idx) => {
                    let div = document.createElement('div');
                    div.className = 'build-item';
                    if (idx === selectedBuildIdx) div.classList.add('selected');
                    
                    let locked = playerLevel < item.unlockLv;
                    if (locked) div.classList.add('locked');

                    div.innerHTML = `
                        <span style="font-size:24px">${item.icon}</span>
                        <div>${item.name}<br><span style="font-size:12px;color:#666">${item.cost}ÂÜÜ</span></div>
                    `;

                    if (locked) {
                        div.innerHTML += `<div class="lock-overlay">Lv.${item.unlockLv} Ëß£Èéñ</div>`;
                    } else {
                        div.onclick = () => selectBuildItem(idx);
                    }

                    menu.appendChild(div);
                });
                menu.style.display = 'flex';
            } else {
                menu.style.display = 'none';
            }
        }
        
        function selectBuildItem(idx) {
            selectedBuildIdx = idx;
            let items = document.querySelectorAll('.build-item');
            items.forEach((el, i) => {
                if(i===idx) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        function setDifficulty(d) {
            selectedDiff = d;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('diff-'+d).classList.add('selected');
        }

        function selectChar(c) {
            selectedChar = c;
            document.querySelectorAll('.char-card').forEach(b => b.classList.remove('selected'));
            document.getElementById('c-'+c).classList.add('selected');
        }

        // --- Event Listeners ---
        window.addEventListener('keydown', e => {
            if (currentMode === 'HOME') {
                if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.w = true;
                if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.a = true;
                if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.s = true;
                if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.d = true;
                
                // Interaction key
                if (e.code === 'Space' && nearbyBuildingIdx !== -1) {
                    let b = buildings[nearbyBuildingIdx];
                    let item = BUILD_ITEMS[b.type];
                    if (item && item.action) {
                        homePlayer.speech = item.action;
                        homePlayer.speechTimer = 120; // 2 seconds
                    }
                }
            } 
            
            if (currentMode === 'WORK') {
                let hitIdx = -1;
                let nearestDist = 9999;

                // Typing Logic
                for (let i = 0; i < workEntities.length; i++) {
                    let ent = workEntities[i];
                    
                    // Match Key?
                    if (ent.targetKey === e.key || ent.zhuyin === e.key) {
                        
                        // Check Range
                        let dist = 9999;
                        if (workModeType === 'weed') {
                            dist = Math.hypot(weedPlayer.x - ent.x, weedPlayer.y - ent.y);
                            if (dist > 120) continue; // Out of range for weed mode
                        } else {
                            dist = Math.hypot(VIEW_WIDTH/2 - ent.x, VIEW_HEIGHT/2 - ent.y);
                        }

                        if (dist < nearestDist) {
                            nearestDist = dist;
                            hitIdx = i;
                        }
                    }
                }

                if (hitIdx !== -1) {
                    let ent = workEntities[hitIdx];
                    workEntities.splice(hitIdx, 1);
                    
                    let baseReward = (ent.type === 'enemy' ? 50 : 10);
                    let expReward = (ent.type === 'enemy' ? 20 : 5);
                    
                    workSessionScore += Math.floor(baseReward * CHAR_STATS[selectedChar].luck);
                    workSessionExp += expReward;
                }
            }
        });

        window.addEventListener('keyup', e => {
            if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.w = false;
            if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.a = false;
            if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.s = false;
            if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.d = false;
        });

        canvas.addEventListener('mousemove', e => {
            const r = canvas.getBoundingClientRect();
            mouse.x = e.clientX - r.left;
            mouse.y = e.clientY - r.top;
        });

        canvas.addEventListener('mousedown', () => {
            if (currentMode === 'HOME' && isBuildMenuOpen) {
                let item = BUILD_ITEMS[selectedBuildIdx];
                if (!item) return;

                if (playerLevel < item.unlockLv) {
                    showNotification("Á≠âÁ¥ö‰∏çË∂≥ÔºÅ");
                    return;
                }

                if (score >= item.cost) {
                    score -= item.cost;
                    document.getElementById('score').innerText = score;
                    buildings.push({
                        x: mouse.x + camera.x,
                        y: mouse.y + camera.y,
                        type: item.type,
                        w: item.w
                    });
                    showNotification(`Âª∫ÈÄ†‰∫Ü ${item.name}!`);
                    saveGameData(); // Auto save after build
                } else {
                    showNotification("Èå¢‰∏çÂ§†ÂñîÔºÅ");
                }
            }
        });

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            VIEW_WIDTH = canvas.width;
            VIEW_HEIGHT = canvas.height;
        }
        window.addEventListener('resize', resize);
        
        // Initial Check for save
        window.onload = function() {
            if (hasSaveData()) {
                document.getElementById('btn-continue').style.display = 'block';
            }
            resize();
            loop();
        };

    </script>
</body>
</html>
