<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Âêâ‰ºäÂç°ÂìáÔºöÊ≥®Èü≥ÂÆ∂ÂúíÂ§ßÂÜíÈö™</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'M PLUS Rounded 1c', "Noto Sans TC", sans-serif;
            background-color: #fdf6e3;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #a5d6a7;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        /* UI Layers */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            box-sizing: border-box;
            z-index: 10;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .hud-left, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #8d6e63;
            border-radius: 12px;
            padding: 8px 15px;
            font-size: 18px;
            font-weight: 800;
            color: #5d4037;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .mode-badge {
            font-size: 20px;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .mode-home { background: #66bb6a; border: 2px solid #2e7d32; }
        .mode-work { background: #ef5350; border: 2px solid #c62828; }

        /* Action Buttons */
        .action-btn {
            background: #fff;
            border: 3px solid #ffa000;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 20px;
            font-weight: bold;
            color: #5d4037;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-go-work { background: #ffe0b2; border-color: #f57c00; color: #e65100; }
        .btn-go-home { background: #c8e6c9; border-color: #388e3c; color: #1b5e20; }

        /* Build Menu (Only visible in Home Mode) */
        #build-palette {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            border: 3px solid #8d6e63;
            margin-top: 10px;
        }

        .build-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
        }
        .build-item:hover { background: #fff8e1; }
        .build-item.selected { background: #ffe0b2; border-color: #ff6f00; }
        
        /* Screens */
        .modal-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            border: 6px solid #ff8a80;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        h1, h2 { margin: 0 0 15px 0; color: #ff8a80; text-shadow: 2px 2px 0 #fff; }
        
        .btn-primary {
            background: #ff8a80;
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 800;
            box-shadow: 0 5px 0 #d84315;
            margin-top: 20px;
        }
        .btn-primary:active { transform: translateY(5px); box-shadow: none; }

        .difficulty-group { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .diff-btn {
            background: #fff; border: 3px solid #ddd; border-radius: 12px; padding: 10px 15px;
            font-size: 16px; font-weight: bold; color: #888; cursor: pointer; transition: 0.2s;
        }
        .diff-btn.selected {
            background: #e1f5fe; border-color: #29b6f6; color: #0277bd;
            transform: scale(1.05); box-shadow: 0 4px 10px rgba(41, 182, 246, 0.2);
        }

        .char-select { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .char-card {
            border: 3px solid #eee; border-radius: 15px; padding: 10px; width: 100px;
            cursor: pointer; transition: 0.2s;
        }
        .char-card.selected { border-color: #ff8a80; background: #fff5f5; transform: translateY(-5px); }
        
        .notification {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 20px 40px;
            border-radius: 50px; font-size: 24px; pointer-events: none;
            opacity: 0; transition: opacity 0.5s;
        }

    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            <div class="hud-top">
                <!-- Left Side: Stats -->
                <div class="hud-left">
                    <div class="info-box">üí∞ <span id="score">0</span> ÂÜÜ</div>
                    <div id="timer-display" class="info-box timer-box" style="display:none;">‚è∞ <span id="timer">60</span>s</div>
                    <div id="home-indicator" class="mode-badge mode-home">üè† Ê∫´È¶®ÂÆ∂Âúí</div>
                    <div id="work-indicator" class="mode-badge mode-work" style="display:none;">‚öîÔ∏è ÊâìÂ∑•Ë®é‰ºê‰∏≠</div>
                </div>

                <!-- Right Side: Controls -->
                <div class="hud-right">
                    <!-- Home Mode Controls -->
                    <div id="home-controls">
                        <button class="action-btn btn-go-work" onclick="switchToWorkMode()">
                            ‚öîÔ∏è Âá∫ÈñÄÊâìÂ∑•
                        </button>
                        <div style="margin-top: 10px;">
                            <button class="action-btn" onclick="toggleBuildMenu()" style="width:100%; justify-content:center;">üî® ‰ΩàÁΩÆÂÆ∂Âúí</button>
                            <div id="build-palette">
                                <div class="build-item selected" onclick="selectBuildItem(0)">
                                    <span style="font-size:24px">üçÑ</span>
                                    <div>ËòëËèáÂ±ã<br><span style="font-size:12px;color:#666">100ÂÜÜ</span></div>
                                </div>
                                <div class="build-item" onclick="selectBuildItem(1)">
                                    <span style="font-size:24px">üõèÔ∏è</span>
                                    <div>ËçâËìÜ<br><span style="font-size:12px;color:#666">50ÂÜÜ</span></div>
                                </div>
                                <div class="build-item" onclick="selectBuildItem(2)">
                                    <span style="font-size:24px">üå∑</span>
                                    <div>Ëä±ÂúÉ<br><span style="font-size:12px;color:#666">30ÂÜÜ</span></div>
                                </div>
                                <div class="build-item" onclick="selectBuildItem(3)">
                                    <span style="font-size:24px">üß±</span>
                                    <div>ÂúçÁâÜ<br><span style="font-size:12px;color:#666">20ÂÜÜ</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Work Mode Controls -->
                    <div id="work-controls" style="display:none;">
                         <button class="action-btn btn-go-home" onclick="returnHome()">
                            üèÉ ÈÄÉÂõûÂÆ∂
                        </button>
                        <div class="info-box keyboard-hint" style="margin-top:10px;">‚å®Ô∏è Ë´ãÁî®Ëã±ÊñáÊâìÂ≠ó</div>
                    </div>
                </div>
            </div>

            <!-- Start Screen -->
            <div id="start-screen" class="modal-screen">
                <div class="modal-content">
                    <h1>Âêâ‰ºäÂç°Âìá<br>Ê≥®Èü≥ÂÆ∂Âúí</h1>
                    <p>‰ΩàÁΩÆ‰Ω†ÁöÑÂÆ∂ÔºåÊ≤íÈå¢Â∞±ÂéªÂ§ñÈù¢ÊâìÂ∑•Èô§ËçâÔºÅ</p>
                    
                    <div class="difficulty-group">
                        <div class="diff-btn" onclick="setDifficulty('easy')" id="diff-easy">üê¢ ÊÖ¢ÈÄü</div>
                        <div class="diff-btn selected" onclick="setDifficulty('normal')" id="diff-normal">üêπ Ê≠£Â∏∏</div>
                        <div class="diff-btn" onclick="setDifficulty('hard')" id="diff-hard">üî• Âø´ÈÄü</div>
                    </div>

                    <div class="char-select">
                        <div class="char-card selected" onclick="selectChar('chiikawa')" id="c-chiikawa">
                            <div style="font-size:30px;">üêπ</div>Âêâ‰ºäÂç°Âìá
                        </div>
                        <div class="char-card" onclick="selectChar('hachiware')" id="c-hachiware">
                            <div style="font-size:30px;">üê±</div>Â∞èÂÖ´
                        </div>
                        <div class="char-card" onclick="selectChar('usagi')" id="c-usagi">
                            <div style="font-size:30px;">üê∞</div>ÁÉèËñ©Â•á
                        </div>
                    </div>
                    <button class="btn-primary" onclick="initGame()">ÈÄ≤ÂÖ•ÂÆ∂Âúí</button>
                </div>
            </div>

            <!-- Work Result Screen -->
            <div id="result-screen" class="modal-screen" style="display: none;">
                <div class="modal-content">
                    <h2 id="result-title">Â∑•‰ΩúÁµêÊùü</h2>
                    <p>Êú¨Ê¨°ÊâìÂ∑•Êî∂ÂÖ•: +<span id="result-income">0</span> ÂÜÜ</p>
                    <!-- Fixed: Call switchToHomeMode directly to avoid loop -->
                    <button class="btn-primary" onclick="switchToHomeMode()">ÂõûÂà∞ÂÆ∂Âúí</button>
                </div>
            </div>
            
            <div id="notification" class="notification">ÈÄöÁü•</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Config ---
        // Home Map is big, Work map is screen size
        const HOME_WIDTH = 2000;
        const HOME_HEIGHT = 2000;
        let VIEW_WIDTH = window.innerWidth;
        let VIEW_HEIGHT = window.innerHeight;

        const ZHUYIN_MAP = {
            '1': '„ÑÖ', 'q': '„ÑÜ', 'a': '„Ñá', 'z': '„Ñà',
            '2': '„Ñâ', 'w': '„Ñä', 's': '„Ñã', 'x': '„Ñå',
            'e': '„Ñç', 'd': '„Ñé', 'c': '„Ñè',
            'r': '„Ñê', 'f': '„Ñë', 'v': '„Ñí',
            '5': '„Ñì', 't': '„Ñî', 'g': '„Ñï', 'b': '„Ññ',
            'y': '„Ñó', 'h': '„Ñò', 'n': '„Ñô',
            'u': '„Ñß', 'j': '„Ñ®', 'm': '„Ñ©',
            '8': '„Ñö', 'i': '„Ñõ', 'k': '„Ñú', ',': '„Ñù',
            '9': '„Ñû', 'o': '„Ñü', 'l': '„Ñ†', '.': '„Ñ°',
            '0': '„Ñ¢', 'p': '„Ñ£', ';': '„Ñ§', '/': '„Ñ•',
            '-': '„Ñ¶', '3': 'Àá', '4': 'Àã', '6': 'Àä', '7': 'Àô'
        };
        const ZHUYIN_KEYS = Object.keys(ZHUYIN_MAP);

        const BUILD_ITEMS = [
            { name: 'ËòëËèáÂ±ã', cost: 100, icon: 'üçÑ', type: 0, w: 80, h: 80 },
            { name: 'ËçâËìÜ', cost: 50, icon: 'üõèÔ∏è', type: 1, w: 50, h: 30 },
            { name: 'Ëä±ÂúÉ', cost: 30, icon: 'üå∑', type: 2, w: 40, h: 40 },
            { name: 'ÂúçÁâÜ', cost: 20, icon: 'üß±', type: 3, w: 40, h: 40 }
        ];

        const CHAR_STATS = {
            chiikawa: { color: '#ffffff', luck: 1.2 },
            hachiware: { color: '#ffffff', luck: 1.0 },
            usagi: { color: '#fdd835', luck: 0.8 }
        };

        const DIFFICULTY = {
            easy: { spawnRate: 120, speed: 0.8 },   // Slow spawn, slow move
            normal: { spawnRate: 80, speed: 1.5 },
            hard: { spawnRate: 40, speed: 2.5 }
        };

        // --- Game State ---
        let currentMode = 'MENU'; // MENU, HOME, WORK
        let selectedChar = 'chiikawa';
        let selectedDiff = 'normal';
        let score = 500; // Start with some money
        
        // Home State
        let homePlayer = { x: 1000, y: 1000, facing: 1 };
        let buildings = []; // {x, y, typeId}
        let camera = { x: 0, y: 0 };
        let isBuildMenuOpen = false;
        let selectedBuildIdx = 0;

        // Work State
        let workTimer = 0;
        let workEntities = []; // Weeds and enemies
        let workSessionScore = 0;
        let workSpawnTimer = 0;
        let playerInvulnerable = 0;

        // Input
        const keys = { w: false, a: false, s: false, d: false };
        let mouse = { x: 0, y: 0 };

        // --- Loop ---
        function loop() {
            update();
            render();
            requestAnimationFrame(loop);
        }

        function update() {
            if (currentMode === 'HOME') updateHome();
            else if (currentMode === 'WORK') updateWork();
        }

        function render() {
            ctx.clearRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
            if (currentMode === 'HOME') renderHome();
            else if (currentMode === 'WORK') renderWork();
        }

        // --- HOME LOGIC ---
        function updateHome() {
            // Movement
            let speed = 6;
            let dx = 0, dy = 0;
            if (keys.w) dy = -speed;
            if (keys.s) dy = speed;
            if (keys.a) dx = -speed;
            if (keys.d) dx = speed;

            homePlayer.x += dx;
            homePlayer.y += dy;
            homePlayer.x = Math.max(50, Math.min(HOME_WIDTH-50, homePlayer.x));
            homePlayer.y = Math.max(50, Math.min(HOME_HEIGHT-50, homePlayer.y));
            
            if (dx !== 0) homePlayer.facing = Math.sign(dx);

            // Camera Follow
            camera.x = homePlayer.x - VIEW_WIDTH/2;
            camera.y = homePlayer.y - VIEW_HEIGHT/2;
            camera.x = Math.max(0, Math.min(HOME_WIDTH-VIEW_WIDTH, camera.x));
            camera.y = Math.max(0, Math.min(HOME_HEIGHT-VIEW_HEIGHT, camera.y));
        }

        function renderHome() {
            ctx.save();
            ctx.translate(-camera.x, -camera.y);

            // Background Pattern
            ctx.fillStyle = '#a5d6a7';
            ctx.fillRect(camera.x, camera.y, VIEW_WIDTH, VIEW_HEIGHT);
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            for(let x=0; x<HOME_WIDTH; x+=100) ctx.fillRect(x, 0, 2, HOME_HEIGHT);
            for(let y=0; y<HOME_HEIGHT; y+=100) ctx.fillRect(0, y, HOME_WIDTH, 2);

            // Draw Buildings (sorted by Y)
            buildings.sort((a,b) => a.y - b.y);
            
            // Draw Objects and Player sorted
            let renderList = [];
            renderList.push({y: homePlayer.y, type:'player'});
            buildings.forEach(b => renderList.push({y: b.y + 20, type:'building', obj: b}));
            
            renderList.sort((a,b) => a.y - b.y);
            
            renderList.forEach(item => {
                if (item.type === 'player') drawPlayer(homePlayer.x, homePlayer.y, homePlayer.facing);
                else drawBuilding(item.obj);
            });

            // Build Ghost
            if (isBuildMenuOpen) {
                let worldMx = mouse.x + camera.x;
                let worldMy = mouse.y + camera.y;
                drawBuildGhost(worldMx, worldMy);
            }

            ctx.restore();
        }

        // --- WORK LOGIC ---
        function updateWork() {
            workTimer -= 1/60;
            if (workTimer <= 0) {
                finishWork(true);
                return;
            }

            // Spawn Logic
            workSpawnTimer++;
            let settings = DIFFICULTY[selectedDiff];
            if (workSpawnTimer > settings.spawnRate) {
                spawnWorkEntity(settings.speed);
                workSpawnTimer = 0;
            }

            // Entity Logic (Auto approach center)
            let centerX = VIEW_WIDTH / 2;
            let centerY = VIEW_HEIGHT / 2;

            for (let i = workEntities.length - 1; i >= 0; i--) {
                let e = workEntities[i];
                let angle = Math.atan2(centerY - e.y, centerX - e.x);
                e.x += Math.cos(angle) * e.speed;
                e.y += Math.sin(angle) * e.speed;

                // Hit Player check
                let dist = Math.hypot(centerX - e.x, centerY - e.y);
                if (dist < 40) {
                    // Hit!
                    if (e.type === 'enemy') {
                        playerInvulnerable = 30;
                        workSessionScore = Math.max(0, workSessionScore - 50); // Penalty
                        showNotification("ÁóõÔºÅÊâ£Ëñ™Ê∞¥ÔºÅ");
                    } else {
                        // Weed touched you? Mild annoyance?
                        // Just disappear for now, no penalty, maybe lost opportunity
                    }
                    workEntities.splice(i, 1);
                }
            }
            
            if (playerInvulnerable > 0) playerInvulnerable--;
            
            // HUD
            document.getElementById('timer').innerText = Math.ceil(workTimer);
            document.getElementById('score').innerText = score + workSessionScore;
        }

        function spawnWorkEntity(baseSpeed) {
            // Spawn at edge of screen
            let side = Math.floor(Math.random() * 4);
            let ex, ey;
            let margin = 50;
            
            if (side === 0) { ex = Math.random() * VIEW_WIDTH; ey = -margin; } // Top
            else if (side === 1) { ex = VIEW_WIDTH + margin; ey = Math.random() * VIEW_HEIGHT; } // Right
            else if (side === 2) { ex = Math.random() * VIEW_WIDTH; ey = VIEW_HEIGHT + margin; } // Bottom
            else { ex = -margin; ey = Math.random() * VIEW_HEIGHT; } // Left

            let isEnemy = Math.random() < 0.3; // 30% enemy
            let key = ZHUYIN_KEYS[Math.floor(Math.random() * ZHUYIN_KEYS.length)];

            workEntities.push({
                x: ex, y: ey,
                type: isEnemy ? 'enemy' : 'weed',
                targetKey: key,
                zhuyin: ZHUYIN_MAP[key],
                speed: baseSpeed * (isEnemy ? 1.2 : 0.8) + (Math.random() * 0.5)
            });
        }

        function renderWork() {
            // Darker background for dangerous work mode
            ctx.fillStyle = '#5d4037'; // Dirt ground color
            ctx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
            
            // Draw Player in center
            let cx = VIEW_WIDTH / 2;
            let cy = VIEW_HEIGHT / 2;
            
            // Draw "Safe Zone" circle
            ctx.beginPath();
            ctx.arc(cx, cy, 100, 0, Math.PI*2);
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 5;
            ctx.stroke();

            // Draw Entities
            workEntities.forEach(e => {
                if (e.type === 'enemy') drawEnemy(e.x, e.y, e.zhuyin);
                else drawWeed(e.x, e.y, e.zhuyin);
            });

            // Draw Player
            if (playerInvulnerable > 0 && Math.floor(Date.now()/50)%2===0) {
                // blink
            } else {
                drawPlayer(cx, cy, 1);
            }
        }

        // --- Shared Drawing ---
        function drawPlayer(x, y, facing) {
            ctx.save();
            ctx.translate(x, y);
            if (facing < 0) ctx.scale(-1, 1);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(0, 25, 20, 8, 0, 0, Math.PI*2); ctx.fill();

            // Body
            let color = CHAR_STATS[selectedChar].color;
            ctx.fillStyle = color;
            ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.fill();

            // Ears
            if (selectedChar === 'usagi') {
                ctx.fillStyle = color;
                ctx.beginPath(); ctx.ellipse(-15, -20, 8, 20, -0.2, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.ellipse(15, -20, 8, 20, 0.2, 0, Math.PI*2); ctx.fill();
            } else if (selectedChar === 'hachiware') {
                ctx.fillStyle = '#42a5f5';
                ctx.beginPath(); ctx.arc(0, -10, 25, Math.PI, 0); ctx.fill(); // hair
                ctx.fillStyle = color;
                ctx.beginPath(); ctx.moveTo(-25,-10); ctx.quadraticCurveTo(0, 10, 25, -10); ctx.fill();
            } else {
                ctx.beginPath(); ctx.arc(-20, -15, 8, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(20, -15, 8, 0, Math.PI*2); ctx.fill();
            }

            // Face
            ctx.fillStyle = '#3e2723';
            ctx.beginPath(); ctx.arc(-8, 0, 3, 0, Math.PI*2); ctx.fill(); 
            ctx.beginPath(); ctx.arc(8, 0, 3, 0, Math.PI*2); ctx.fill(); 
            
            // Blush
            ctx.fillStyle = '#ffcdd2';
            ctx.globalAlpha = 0.6;
            ctx.beginPath(); ctx.arc(-15, 5, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(15, 5, 5, 0, Math.PI*2); ctx.fill();

            ctx.restore();
        }

        function drawWeed(x, y, char) {
            ctx.save();
            ctx.translate(x, y);
            // Floating motion
            let bob = Math.sin(Date.now() * 0.01) * 5;
            ctx.translate(0, bob);
            
            ctx.fillStyle = '#66bb6a';
            ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(-15,-30, -30,-10); ctx.quadraticCurveTo(-10,-10, 0,0); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(15,-30, 30,-10); ctx.quadraticCurveTo(0,-10, 0,0); ctx.fill();
            
            drawZhuyinBubble(0, -30, char, '#8d6e63');
            ctx.restore();
        }

        function drawEnemy(x, y, char) {
            ctx.save();
            ctx.translate(x, y);
            let bob = Math.sin(Date.now() * 0.01) * 5;
            ctx.translate(0, bob);

            ctx.fillStyle = '#5c6bc0';
            ctx.beginPath(); ctx.arc(0, -15, 20, 0, Math.PI*2); ctx.fill();
            // Wings
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.beginPath(); ctx.ellipse(-20, -25, 12, 6, -0.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(20, -25, 12, 6, 0.5, 0, Math.PI*2); ctx.fill();
            
            drawZhuyinBubble(0, -45, char, '#ef5350');
            ctx.restore();
        }

        function drawZhuyinBubble(dx, dy, char, color) {
            if (!char) return;
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.arc(dx, dy, 18, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = 'black'; ctx.font = "bold 20px 'Noto Serif TC'"; 
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(char, dx, dy+2);
        }

        function drawBuilding(b) {
            ctx.save();
            ctx.translate(b.x, b.y);
            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath(); ctx.ellipse(0, 10, b.w/2, 10, 0, 0, Math.PI*2); ctx.fill();
            
            if (b.type === 0) { // Mushroom
                ctx.fillStyle = '#ffe0b2'; ctx.fillRect(-20, -30, 40, 30);
                ctx.fillStyle = '#ef5350'; ctx.beginPath(); ctx.arc(0, -30, 45, Math.PI, 0); ctx.fill();
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-20, -45, 8, 0, Math.PI*2); ctx.fill();
            } else if (b.type === 1) { // Bed
                ctx.fillStyle = '#dcedc8'; ctx.fillRect(-25, -15, 50, 30);
                ctx.fillStyle = 'white'; ctx.fillRect(-20, -10, 15, 20);
            } else if (b.type === 2) { // Flower
                ctx.fillStyle = '#8d6e63'; ctx.beginPath(); ctx.ellipse(0, 0, 20, 10, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#e91e63'; ctx.font = "20px serif"; ctx.fillText("üå∑", -10, 5);
            } else if (b.type === 3) { // Wall
                ctx.fillStyle = '#bdbdbd'; ctx.fillRect(-20, -20, 40, 30);
                ctx.strokeStyle = '#757575'; ctx.strokeRect(-20,-20,40,30);
            }
            ctx.restore();
        }

        function drawBuildGhost(x, y) {
            let item = BUILD_ITEMS[selectedBuildIdx];
            ctx.save();
            ctx.translate(x, y);
            ctx.globalAlpha = 0.6;
            ctx.fillStyle = (score >= item.cost) ? '#81c784' : '#e57373';
            ctx.beginPath(); ctx.arc(0,0, 40, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black'; ctx.font = "30px sans-serif"; 
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(item.icon, 0, 0);
            ctx.restore();
        }

        // --- Game Controls ---
        function initGame() {
            document.getElementById('start-screen').style.display = 'none';
            switchToHomeMode();
        }

        function switchToHomeMode() {
            currentMode = 'HOME';
            document.getElementById('home-controls').style.display = 'block';
            document.getElementById('work-controls').style.display = 'none';
            document.getElementById('home-indicator').style.display = 'block';
            document.getElementById('work-indicator').style.display = 'none';
            document.getElementById('timer-display').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            
            // Apply work earnings if coming back
            if (workSessionScore > 0) {
                score += workSessionScore;
                workSessionScore = 0;
            }
            document.getElementById('score').innerText = score;
        }

        function switchToWorkMode() {
            currentMode = 'WORK';
            document.getElementById('home-controls').style.display = 'none';
            document.getElementById('work-controls').style.display = 'block';
            document.getElementById('home-indicator').style.display = 'none';
            document.getElementById('work-indicator').style.display = 'block';
            document.getElementById('timer-display').style.display = 'flex';
            
            // Reset Work State
            workTimer = 60;
            workEntities = [];
            workSessionScore = 0;
            isBuildMenuOpen = false;
            document.getElementById('build-palette').style.display = 'none';
        }

        function finishWork(finished) {
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('result-title').innerText = finished ? "Â∑•‰ΩúÂÆåÊàêÔºÅ" : "ÊèêÊó©ÂõûÂÆ∂";
            document.getElementById('result-income').innerText = workSessionScore;
        }
        
        function returnHome() {
            if (currentMode === 'WORK') {
                finishWork(false);
            } else {
                switchToHomeMode();
            }
        }

        function showNotification(msg) {
            let el = document.getElementById('notification');
            el.innerText = msg;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 1500);
        }

        // --- Interactions ---
        function toggleBuildMenu() {
            isBuildMenuOpen = !isBuildMenuOpen;
            const menu = document.getElementById('build-palette');
            menu.style.display = isBuildMenuOpen ? 'flex' : 'none';
        }
        
        function selectBuildItem(idx) {
            selectedBuildIdx = idx;
            document.querySelectorAll('.build-item').forEach((el, i) => {
                if(i===idx) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        function setDifficulty(d) {
            selectedDiff = d;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('diff-'+d).classList.add('selected');
        }

        function selectChar(c) {
            selectedChar = c;
            document.querySelectorAll('.char-card').forEach(b => b.classList.remove('selected'));
            document.getElementById('c-'+c).classList.add('selected');
        }

        // --- Event Listeners ---
        window.addEventListener('keydown', e => {
            if (currentMode === 'HOME') {
                // FIXED: Use e.code to ignore IME (Zhuyin) interference
                if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.w = true;
                if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.a = true;
                if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.s = true;
                if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.d = true;
            } else if (currentMode === 'WORK') {
                // Typing check
                let nearestDist = 9999;
                let hitIdx = -1;

                // Find nearest matching entity
                for (let i = 0; i < workEntities.length; i++) {
                    let ent = workEntities[i];
                    if (ent.targetKey === e.key || ent.zhuyin === e.key) {
                        let dist = Math.hypot(VIEW_WIDTH/2 - ent.x, VIEW_HEIGHT/2 - ent.y);
                        if (dist < nearestDist) {
                            nearestDist = dist;
                            hitIdx = i;
                        }
                    }
                }

                if (hitIdx !== -1) {
                    let ent = workEntities[hitIdx];
                    workEntities.splice(hitIdx, 1);
                    
                    let reward = (ent.type === 'enemy' ? 50 : 10) * CHAR_STATS[selectedChar].luck;
                    workSessionScore += Math.floor(reward);
                }
            }
        });

        window.addEventListener('keyup', e => {
            if(e.code === 'KeyW' || e.code === 'ArrowUp') keys.w = false;
            if(e.code === 'KeyA' || e.code === 'ArrowLeft') keys.a = false;
            if(e.code === 'KeyS' || e.code === 'ArrowDown') keys.s = false;
            if(e.code === 'KeyD' || e.code === 'ArrowRight') keys.d = false;
        });

        canvas.addEventListener('mousemove', e => {
            const r = canvas.getBoundingClientRect();
            mouse.x = e.clientX - r.left;
            mouse.y = e.clientY - r.top;
        });

        canvas.addEventListener('mousedown', () => {
            if (currentMode === 'HOME' && isBuildMenuOpen) {
                let item = BUILD_ITEMS[selectedBuildIdx];
                if (score >= item.cost) {
                    score -= item.cost;
                    document.getElementById('score').innerText = score;
                    buildings.push({
                        x: mouse.x + camera.x,
                        y: mouse.y + camera.y,
                        type: item.type,
                        w: item.w
                    });
                    showNotification(`Âª∫ÈÄ†‰∫Ü ${item.name}!`);
                } else {
                    showNotification("Èå¢‰∏çÂ§†ÂñîÔºÅ");
                }
            }
        });

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            VIEW_WIDTH = canvas.width;
            VIEW_HEIGHT = canvas.height;
        }
        window.addEventListener('resize', resize);
        
        resize();
        loop();

    </script>
</body>
</html>
